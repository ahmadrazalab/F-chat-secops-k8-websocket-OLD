name: Build ChatAPP

on:
  push:
    branches:
      - main
    tags:
      - 'v1.*'

jobs:
  code-scan:
    runs-on: digitalocean
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    
    - name: run conatiner to scan the code review 
      run: |
        docker run --rm -e SONAR_HOST_URL="https://sonar.kubecloud.in.net" -e SONAR_LOGIN="sqb_68771ad6a301d6281078273ab3ab232d5989da8e" -v "$(pwd):/usr/src"   sonarsource/sonar-scanner-cli

  build-api:
    runs-on: digitalocean
    needs: code-scan  # This job will run only if 'code-scan' succeeds 

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    
    - name: Log in to Docker Hub
      run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

    - name: Build Docker image
      run: docker build -t noscopev6/chatapp-b:$GITHUB_SHA .

    - name: Push Docker image
      run: docker push noscopev6/chatapp-b:$GITHUB_SHA

    - name: Push Docker image
      run: docker logout
    
  build-frontend:
    runs-on: digitalocean
    needs: build-api  # This job will run only if 'build-api' succeeds

    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    
    - name: Log in to Docker Hub
      run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

    - name: Build Docker image
      run: cd ./frontend/chat-app && docker build -t noscopev6/chatapp-f:$GITHUB_SHA .

    - name: Push Docker image
      run: docker push noscopev6/chatapp-f:$GITHUB_SHA

    - name: Push Docker image
      run: docker logout